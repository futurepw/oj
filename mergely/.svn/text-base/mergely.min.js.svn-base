/**
 * Copyright (c) 2012 by Jamie Peabody, http://www.mergely.com
 * All rights reserved.
 * Version: 3.0 2012-11-03
 */
Mgly={},Mgly.sizeOf=function(e){var t=0,n;for(n in e)e.hasOwnProperty(n)&&t++;return t},Mgly.LCS=function(e,t){this.length=this._lcs(e,t);var n=[];e=e.split(""),t=t.split(""),e.unshift(""),t.unshift(""),this.C=n,this.x=e,this.y=t;var r=0,i=0;for(r=0;r<e.length+1;++r){n[r]=[];for(i=0;i<t.length+1;++i)n[r][i]=0}for(r=1;r<e.length+1;++r)for(i=1;i<t.length+1;++i)e[r-1]==t[i-1]?n[r][i]=n[r-1][i-1]+1:n[r][i]=Math.max(n[r][i-1],n[r-1][i]);this.ready=1},$.extend(Mgly.LCS.prototype,{clear:function(){this.ready=0},diff:function(e,t){this._diff(this.x.length-1,this.y.length-1,e,t)},_diff:function(e,t,n,r){var i=this.x,s=this.y,o=this.C;this.ready&&e>0&&t>0&&i[e]==s[t]?this._diff(e-1,t-1,n,r):t>0&&(e==0||o[e][t-1]>=o[e-1][t])?(this._diff(e,t-1,n,r),n&&n(t-1,s[t])):e>0&&(t==0||o[e][t-1]<o[e-1][t])&&(this._diff(e-1,t,n,r),r&&r(e-1,i[e]))},_lcs:function(e,t){var n=0,r=Array(e.length);for(a=0;a<=e.length;a++){r[a]=Array(t.length);for(b=0;b<=t.length;b++)r[a][b]=0}for(var i=0;i<e.length;i++)for(var s=0;s<t.length;s++)e[i]==t[s]?(r[i][s]==0?r[i+1][s+1]=1:r[i+1][s+1]=r[i][s]+1,r[i+1][s+1]>n&&(n=r[i+1][s+1])):r[i+1][s+1]=0;return n}}),Mgly.diff=function(e,t,n){this.diff_codes={},this.max_code=0;var r=e.split("\n"),i=t.split("\n");e.length==0&&(r=[]),t.length==0&&(i=[]);var s=new Object;s.data=this._diff_codes(r),s.modified={},s.length=Mgly.sizeOf(s.data);var o=new Object;o.data=this._diff_codes(i),o.modified={},o.length=Mgly.sizeOf(o.data);var u=s.length+o.length+1,a=Array(2*u+2),f=Array(2*u+2);this._lcs(s,0,s.length,o,0,o.length,f,a),this._optimize(s),this._optimize(o),this.items=this._create_diffs(s,o),n&&(this.lhs_lines=r,this.rhs_lines=i)},$.extend(Mgly.diff.prototype,{changes:function(){return this.items},normal_form:function(){var e="";for(var t in this.items){var n=this.items[t],r="",i="",s="c";n.lhs_deleted_count==0&&n.rhs_inserted_count>0?s="a":n.lhs_deleted_count>0&&n.rhs_inserted_count==0&&(s="d"),n.lhs_deleted_count==1?r=n.lhs_start+1:n.lhs_deleted_count==0?r=n.lhs_start:r=n.lhs_start+1+","+(n.lhs_start+n.lhs_deleted_count),n.rhs_inserted_count==1?i=n.rhs_start+1:n.rhs_inserted_count==0?i=n.rhs_start:i=n.rhs_start+1+","+(n.rhs_start+n.rhs_inserted_count),e+=r+s+i+"\n";if(this.rhs_lines&&this.lhs_lines){for(var o=n.lhs_start;o<n.lhs_start+n.lhs_deleted_count;++o)e+="< "+this.lhs_lines[o]+"\n";n.rhs_inserted_count&&n.lhs_deleted_count&&(e+="---\n");for(var o=n.rhs_start;o<n.rhs_start+n.rhs_inserted_count;++o)e+="> "+this.rhs_lines[o]+"\n"}}return e},_diff_codes:function(e){var t=this.max_code,n={};for(var r=0;r<e.length;++r){var i=e[r],s=this.diff_codes[i];s!=undefined?n[r]=s:(this.max_code++,this.diff_codes[i]=this.max_code,n[r]=this.max_code)}return n},_lcs:function(e,t,n,r,i,s,o,u){while(t<n&&i<s&&e.data[t]==r.data[i])++t,++i;while(t<n&&i<s&&e.data[n-1]==r.data[s-1])--n,--s;if(t==n)while(i<s)r.modified[i++]=!0;else if(i==s)while(t<n)e.modified[t++]=!0;else{var a=this._sms(e,t,n,r,i,s,o,u);this._lcs(e,t,a.x,r,i,a.y,o,u),this._lcs(e,a.x,n,r,a.y,s,o,u)}},_sms:function(e,t,n,r,i,s,o,u){var a=e.length+r.length+1,f=t-i,l=n-s,c=n-t-(s-i),h=(c&1)!=0,p=a-f,d=a-l,v=(n-t+s-i)/2+1;u[p+f+1]=t,o[d+l-1]=n;var m=new Object;for(var g=0;g<=v;++g){for(var y=f-g;y<=f+g;y+=2){var b,w;y==f-g?b=u[p+y+1]:(b=u[p+y-1]+1,y<f+g&&u[p+y+1]>=b&&(b=u[p+y+1])),w=b-y;while(b<n&&w<s&&e.data[b]==r.data[w])b++,w++;u[p+y]=b;if(h&&l-g<y&&y<l+g&&o[d+y]<=u[p+y])return m.x=u[p+y],m.y=u[p+y]-y,m}for(var y=l-g;y<=l+g;y+=2){var b,w;y==l+g?b=o[d+y-1]:(b=o[d+y+1]-1,y>l-g&&o[d+y-1]<b&&(b=o[d+y-1])),w=b-y;while(b>t&&w>i&&e.data[b-1]==r.data[w-1])b--,w--;o[d+y]=b;if(!h&&f-g<=y&&y<=f+g&&o[d+y]<=u[p+y])return m.x=u[p+y],m.y=u[p+y]-y,m}}throw"the algorithm should never come here."},_optimize:function(e){var t=0,n=0;while(t<e.length){while(t<e.length&&(e.modified[t]==undefined||e.modified[t]==0))t++;n=t;while(n<e.length&&e.modified[n]==1)n++;n<e.length&&e.data[t]==e.data[n]?(e.modified[t]=!1,e.modified[n]=!0):t=n}},_create_diffs:function(e,t){var n=[],r=0,i=0,s=0,o=0;while(s<e.length||o<t.length)if(s<e.length&&!e.modified[s]&&o<t.length&&!t.modified[o])s++,o++;else{r=s,i=o;while(s<e.length&&(o>=t.length||e.modified[s]))s++;while(o<t.length&&(s>=e.length||t.modified[o]))o++;if(r<s||i<o){var u=new Object;u.lhs_start=r,u.rhs_start=i,u.lhs_deleted_count=s-r,u.rhs_inserted_count=o-i,n.push(u)}}return n}}),Mgly.mergely=function(e,t){CodeMirror.defineExtension("centerOnCursor",function(){var e=this.cursorCoords(null,"local");this.scrollTo(null,(e.y+e.yBot)/2-this.getScrollerElement().clientHeight/2)}),e&&this.init(e,t)},$.extend(Mgly.mergely.prototype,{name:"mergely",init:function(e,t){this.settings={autoupdate:!0,autoresize:!0,fadein:"fast",editor_width:"400px",editor_height:"400px",resize_timeout:500,change_timeout:150,fgcolor:{a:"#4ba3fa",c:"#cccccc",d:"#ff7f7f"},_bgcolor:"#eee",lhs:function(e){},rhs:function(e){},loaded:function(){},height:function(e){return e-20},width:function(e){return e},resize:function(){var t=$(e).parent().width(),n=$(window).height();this.width&&(t=this.width(t)),this.height&&(n=this.height(n));var r=t/2-16-8,i=n,s=$(e);s.find(".mergely-column").css({width:r+"px"}),s.find(".mergely-column, .mergely-canvas, .mergely-margin, .mergely-column textarea, .CodeMirror-scroll").css({height:i+"px"}),s.find(".mergely-canvas").css({height:i+"px"}),s.find(".mergely-column textarea").css({width:r+"px"}),s.css({width:t+"px",height:n+"px"}),s.css("display")=="none"&&(this.fadein!=0?s.fadeIn(this.fadein):s.show(),this.loaded&&this.loaded()),this.resized&&this.resized()},_debug:"",resized:function(){}};var n={mode:"text/plain",readOnly:!1,lineWrapping:!1,lineNumbers:!0};this.lhs_cmsettings={},this.rhs_cmsettings={},this.element=$(e),t&&t.cmsettings&&$.extend(this.lhs_cmsettings,n,t.cmsettings,t.lhs_cmsettings),t&&t.cmsettings&&$.extend(this.rhs_cmsettings,n,t.cmsettings,t.rhs_cmsettings),t&&$.extend(this.settings,t),this.element.bind("destroyed",$.proxy(this.teardown,this)),$.data(e,this.name,this),this._setup(e)},bind:function(){var e=$("#"+this.id+"-rhs").get(0);if(!e){console.error("rhs textarea not defined - Mergely not initialized properly");return}var t=$("#"+this.id+"-lhs").get(0);if(!e){console.error("lhs textarea not defined - Mergely not initialized properly");return}var n=this;this.editor=[];var r=jQuery.extend({onChange:function(){n.settings.autoupdate&&n._changing(n.id+"-lhs",n.id+"-rhs")},onScroll:function(){n._scrolling(n.id+"-lhs")}},this.lhs_cmsettings);this.editor[this.id+"-lhs"]=CodeMirror.fromTextArea(t,r);var i=jQuery.extend({onChange:function(){n.settings.autoupdate&&n._changing(n.id+"-lhs",n.id+"-rhs")},onScroll:function(){n._scrolling(n.id+"-rhs")}},this.rhs_cmsettings);this.editor[this.id+"-rhs"]=CodeMirror.fromTextArea(e,i);var s=null,o=function(){n.em_height=null,n.settings.resize&&n.settings.resize(),n.editor[n.id+"-lhs"].refresh(),n.editor[n.id+"-rhs"].refresh(),n._changing(n.id+"-lhs",n.id+"-rhs")};$(window).resize(function(){s&&clearTimeout(s),s=setTimeout(o,n.settings.resize_timeout)}),o()},unbind:function(){this.changed_timeout!=null&&clearTimeout(this.changed_timeout),this.editor[this.id+"-lhs"].toTextArea(),this.editor[this.id+"-rhs"].toTextArea()},destroy:function(){this.element.unbind("destroyed",this.teardown),this.teardown()},teardown:function(){this.unbind()},lhs:function(e){this.editor[this.id+"-lhs"].setValue(e)},rhs:function(e){this.editor[this.id+"-rhs"].setValue(e)},update:function(){this._changing(this.id+"-lhs",this.id+"-rhs")},scrollTo:function(e,t){var n=this.editor[this.id+"-lhs"],r=this.editor[this.id+"-rhs"];e=="lhs"?(n.setCursor(t),n.centerOnCursor()):(r.setCursor(t),r.centerOnCursor())},options:function(e){$.extend(this.settings,e)},swap:function(){if(this.lhs_cmsettings.readOnly||this.rhs_cmsettings.readOnly)return;var e=this.editor[this.id+"-lhs"],t=this.editor[this.id+"-rhs"],n=t.getValue();t.setValue(e.getValue()),e.setValue(n)},merge:function(e){var t=this.editor[this.id+"-lhs"],n=this.editor[this.id+"-rhs"];e=="lhs"&&!this.lhs_cmsettings.readOnly?t.setValue(n.getValue()):this.rhs_cmsettings.readOnly||n.setValue(t.getValue())},get:function(e){var t=this.editor[this.id+"-"+e],n=t.getValue();return n==undefined?"":n},clear:function(e){if(e=="lhs"&&this.lhs_cmsettings.readOnly)return;if(e=="rhs"&&this.rhs_cmsettings.readOnly)return;var t=this.editor[this.id+"-"+e];t.setValue("")},cm:function(e){return this.editor[this.id+"-"+e]},search:function(e,t){var n=this.editor[this.id+"-lhs"],r=this.editor[this.id+"-rhs"],i;e=="lhs"?i=n:i=r;if(i.getSelection().length==0||this.prev_query[e]!=t)this.cursor[this.id]=i.getSearchCursor(t,{line:0,ch:0},!1),this.prev_query[e]=t;this.cursor[this.id].findNext()?i.setSelection(this.cursor[this.id].from(),this.cursor[this.id].to()):this.cursor[this.id]=i.getSearchCursor(t,{line:0,ch:0},!1)},resize:function(){this.settings.resize(),this._changing(this.id+"-lhs",this.id+"-rhs")},diff:function(){var e=this.editor[this.id+"-lhs"].getValue(),t=this.editor[this.id+"-rhs"].getValue(),n=new Mgly.diff(e,t,retain_lines=!0);return n.normal_form()},_setup:function(e){$(this.element).hide(),this.id=$(e).attr("id");var t=this.settings.editor_height,n=this.settings.editor_width;this.changed_timeout=null,this.change_funcs=[],this.prev_query=[],this.cursor=[],this.change_exp=new RegExp(/(\d+(?:,\d+)?)([acd])(\d+(?:,\d+)?)/);var r,i;if($.button!=undefined)r='<button title="Merge left"></button>',i='<button title="Merge right"></button>';else{var s="width:1em;height:1em;background-color:#888;cursor:pointer;text-align:center;color:#eee;border:1px solid: #222;margin-right:5px;";r='<div style="'+s+'" title="Merge left">&lt;</div>',i='<div style="'+s+'" title="Merge right">&gt;</div>'}this.merge_rhs_button=$(i),this.merge_lhs_button=$(r),this.merge_rhs_button.corner&&this.merge_rhs_button.corner("3px"),this.merge_lhs_button.corner&&this.merge_lhs_button.corner("3px"),$(this.element).append($('<div class="mergely-margin" style="height: '+t+'"><canvas id="'+this.id+'-lhs-margin" width="8px" height="'+t+'"></canvas></div>')),$(this.element).append($('<div style="width:'+n+"; height:"+t+'" id="'+this.id+'-editor-lhs" class="mergely-column"><textarea style="" id="'+this.id+'-lhs"></textarea></div>')),$(this.element).append($('<div class="mergely-canvas" style="height: '+t+'"><canvas id="'+this.id+"-lhs-"+this.id+'-rhs-canvas" style="width:28px" width="28px" height="'+t+'"></canvas></div>')),$(this.element).append($('<div style="width:'+n+"; height:"+t+'" id="'+this.id+'-editor-rhs" class="mergely-column"><textarea style="" id="'+this.id+'-rhs"></textarea></div>')),$(this.element).append($('<div class="mergely-margin" style="height: '+t+'"><canvas id="'+this.id+'-rhs-margin" width="8px" height="'+t+'"></canvas></div>'));var o="#"+this.id+" .CodeMirror-gutter-text { padding: 5px 0 0 0; }"+"#"+this.id+" .CodeMirror-lines pre, "+"#"+this.id+" .CodeMirror-gutter-text pre { line-height: 18px; }";this.settings.autoresize&&(o+=this.id+" .CodeMirror-scroll { height: 100%; overflow: auto; }"),$('<style type="text/css">'+o+"</style>").appendTo("head"),this.bind(),this.settings.lhs&&this.settings.lhs(this.editor[this.id+"-lhs"].setValue),this.settings.rhs&&this.settings.rhs(this.editor[this.id+"-rhs"].setValue),this.settings.resize();var u=this,a={lhs:this.editor[this.id+"-lhs"],rhs:this.editor[this.id+"-rhs"]};$(".merge-button").live("click",function(e){console.log("lhs hover over",e,this);var t="rhs",n="lhs",r=$(this).parents("#"+u.id+"-editor-lhs");r.length&&(t="lhs",n="rhs");var i=a[t].coordsChar({x:e.pageX,y:e.pageY});console.log("pos",t,i);var s=null,o=a[t].lineInfo(i.line);$.each(o.bgClass.split(" "),function(e,t){console.log("clazz",e,t);if(t.indexOf("cid-")==0)return s=parseInt(t.split("-")[1]),!1});var f=u.changes[s];console.log("change",f);var l={lhs:a.lhs.lineInfo(f["lhs-line-to"]),rhs:a.rhs.lineInfo(f["rhs-line-to"])},c=a[t].getRange({line:f[t+"-line-from"],ch:0},{line:f[t+"-line-to"],ch:l[t].text.length});if(f["op"]=="c")a[n].replaceRange(c,{line:f[n+"-line-from"],ch:0},{line:f[n+"-line-to"],ch:l[n].text.length});else{var h=parseInt(f[n+"-line-from"]),p=parseInt(f[n+"-line-to"]);for(var d=p;d>=h;--d)a[n].removeLine(d)}return a.lhs.setValue(a.lhs.getValue()),a.rhs.setValue(a.rhs.getValue()),!1})},_scrolling:function(e){if(self._skipscroll===!0){self._skipscroll=!1;return}var t=$(this.editor[e].getScrollerElement());this.midway==undefined&&(this.midway=(t.height()/2+t.offset().top).toFixed(2));var n=this.editor[e].coordsChar({x:0,y:this.midway}),r=t.scrollTop(),i=t.scrollLeft();this.trace("scroll","side",e),this.trace("scroll","midway",this.midway),this.trace("scroll","midline",n),this.trace("scroll","top_to",r),this.trace("scroll","left_to",i);for(var s in this.editor){if(e==s)continue;var o=e.replace(this.id+"-",""),u=s.replace(this.id+"-",""),a=0,f=null;for(var l in this.changes){var c=this.changes[l];n.line>=c[o+"-line-from"]&&(f=c,n.line>=f[o+"-line-to"]&&(a+=c[o+"-y-end"]-c[o+"-y-start"]-(c[u+"-y-end"]-c[u+"-y-start"])))}var h=!0;f&&(this.trace("scroll","last change before midline",f),f[o+"-line-from"]<n.line&&f[o+"-line-to"]>n.line&&(h=!1)),this.trace("scroll","scroll",h);if(h){this.trace("scroll","scrolling other side",r-a);var t=$(this.editor[s].getScrollerElement());self._skipscroll=!0,t.scrollTop(r-a).scrollLeft(i)}else this.trace("scroll","not scrolling other side");this._calculate_offsets(this.id+"-lhs",this.id+"-rhs",this.changes),this._draw_diff(this.id+"-lhs",this.id+"-rhs",this.changes),this.trace("scroll","scrolled")}},_changing:function(e,t){var n=this;this.changed_timeout!=null&&clearTimeout(this.changed_timeout),this.changed_timeout=setTimeout(function(){n._changed(e,t)},this.settings.change_timeout)},_changed:function(e,t){for(var n in this.editor){var r=this.editor[n];r.operation(function(){for(var e=0,t=r.lineCount();e<t;++e)r.clearMarker(e),r.setLineClass(e,null,null)})}for(var i in this.change_funcs){var s=this.change_funcs[i];s.clear!=undefined?s.clear():s()}this._diff(e,t)},_diff:function(e,t){var n=this.editor[e].getValue(),r=this.editor[t].getValue(),i=new Mgly.diff(n,r);this.changes=this._parse_diff(e,t,i.normal_form()),this._calculate_offsets(e,t,this.changes),this._markup_changes(e,t,this.changes),this._draw_diff(e,t,this.changes)},_parse_diff:function(e,t,n){this.trace("diff","diff results:\n",n);var r=[],i=0,s=n.split(/\n/);for(var o=0;o<s.length;++o){if(s[o].length==0)continue;var u={},a=this.change_exp.exec(s[o]);if(a==null)continue;var f=a[1].split(",");u["lhs-line-from"]=f[0]-1,f.length==1?u["lhs-line-to"]=f[0]-1:u["lhs-line-to"]=f[1]-1;var l=a[3].split(",");u["rhs-line-from"]=l[0]-1,l.length==1?u["rhs-line-to"]=l[0]-1:u["rhs-line-to"]=l[1]-1,u["lhs-line-from"]<0&&(u["lhs-line-from"]=0),u["lhs-line-to"]<0&&(u["lhs-line-to"]=0),u["rhs-line-from"]<0&&(u["rhs-line-from"]=0),u["rhs-line-to"]<0&&(u["rhs-line-to"]=0),u.op=a[2],r[i++]=u,this.trace("diff","change",u)}return r},_get_extents:function(){return{"top-offset":this.draw_top_offset,"em-height":this.em_height,"draw-lhs-min":this.draw_lhs_min,"draw-rhs-max":this.draw_rhs_max}},_calculate_offsets:function(e,t,n){if(this.em_height==null){var r=$("#"+this.id+"-lhs-margin").first(),i=r.offset().top;if(!i)return;this.draw_top_offset=.5-i,this.em_height=$(".CodeMirror-lines pre").get(0).offsetHeight,this.em_height||(console.warn("Failed to calculate offsets, using 18 by default"),this.em_height=18),this.draw_lhs_min=.5;var s=$("#"+e+"-"+t+"-canvas");s.length||console.error("failed to find canvas","#"+e+"-"+t+"-canvas");if(!s.width()){console.error("canvas width is 0");return}this.draw_rhs_max=$("#"+e+"-"+t+"-canvas").width()-.5,this.draw_lhs_width=5,this.draw_rhs_width=5,this.trace("calc","change offsets calculated",{top_offset:i,lhs_min:this.draw_lhs_min,rhs_max:this.draw_rhs_max,lhs_width:this.draw_lhs_width,rhs_width:this.draw_rhs_width})}for(var o in n){var u=n[o],a=2,f=this.editor[e].charCoords({line:u["lhs-line-from"]}),l=this.editor[e].charCoords({line:u["lhs-line-to"]}),c=this.editor[t].charCoords({line:u["rhs-line-from"]}),h=this.editor[t].charCoords({line:u["rhs-line-to"]});u["op"]=="a"?u["rhs-line-from"]>0&&(f.y=f.yBot,f.yBot+=this.em_height,l=f):u["op"]=="d"&&u["lhs-line-from"]>0&&(c.y=c.yBot,c.yBot+=this.em_height,h=c),u["lhs-y-start"]=this.draw_top_offset+f.y,u["op"]=="c"||u["op"]=="d"?u["lhs-y-end"]=this.draw_top_offset+l.yBot-a:u["lhs-y-end"]=this.draw_top_offset+l.y-a,u["rhs-y-start"]=this.draw_top_offset+c.y,u["op"]=="c"||u["op"]=="a"?u["rhs-y-end"]=this.draw_top_offset+h.yBot-a:u["rhs-y-end"]=this.draw_top_offset+h.y-a,this.trace("calc","change calculated",o,u)}return n},_markup_changes:function(e,t,n){$(".merge-button").remove();var r=this,i=this.editor[e],s=this.editor[t];i.operation(function(){for(var o in n){var u=n[o],a="mergely "+u.op+" cid-"+o+" ";if(u["lhs-line-from"]==u["lhs-line-to"]){if(u["op"]=="a")if(u["rhs-line-from"]>0){var f=a+"lhs start end";i.setLineClass(u["lhs-line-from"],null,f)}else{var f=a+"lhs start";i.setLineClass(u["lhs-line-from"],null,f)}else if(u["op"]=="d"){var f=a+"lhs start end";i.setLineClass(u["lhs-line-from"],null,f)}else if(u["op"]=="c"){var f=a+"lhs start end";i.setLineClass(u["lhs-line-from"],null,f)}}else{var f=a+"lhs start";i.setLineClass(u["lhs-line-from"],null,f),f=a+"lhs end",i.setLineClass(u["lhs-line-to"],null,f)}if(u["op"]=="d"){var l=u["lhs-line-from"],c=u["lhs-line-to"],h=i.lineInfo(c);if(h){var p=i.markText({line:l,ch:0},{line:c,ch:h.text.length},"mergely ch d lhs");r.change_funcs.push(p)}}else if(u["op"]=="c")for(var d=u["lhs-line-from"],v=u["rhs-line-from"],o=0;d>=0&&d<=u["lhs-line-to"]||v>=0&&v<=u["rhs-line-to"];++d,++v){if(v+o>u["rhs-line-to"]){var m=i.getLine(d),p=i.markText({line:d,ch:0},{line:d,ch:m.length},"mergely ch d lhs");r.change_funcs.push(p);continue}if(d+o>u["lhs-line-to"]){var g=s.getLine(v),p=i.markText({line:v,ch:0},{line:v,ch:m.length},"mergely ch a rhs");r.change_funcs.push(p);continue}var m=i.getLine(d),g=s.getLine(v),y={line:-1,ch:-1},b={line:-1,ch:-1},w={line:-1,ch:-1},E={line:-1,ch:-1},S=new Mgly.LCS(m,g),x=Math.max(m.length,g.length);x==0&&(x=1);var T=1*S.length/x*100;T<10&&S.clear(),S.diff(added=function(e,n){if(w.ch<0)w.line=v,w.ch=e,E.line=v,E.ch=e;else if(e==E.ch+1)E.ch=e;else{if(w.ch>=0&&E.ch>=w.ch){E.ch+=1;var i=r.editor[t].markText(w,E,"mergely ch a rhs");r.change_funcs.push(i)}w.ch=-1,E.ch=-1,n!="\n"&&this.added(e,n)}},removed=function(t,n){if(y.ch<0)y.line=d,y.ch=t,b.line=d,b.ch=t;else if(t==b.ch+1)b.ch=t;else{if(y.ch>=0&&b.ch>=y.ch){b.ch+=1;var i=r.editor[e].markText(y,b,"mergely ch d lhs");r.change_funcs.push(i)}y.ch=-1,b.ch=-1,n!="\n"&&this.removed(t,n)}});if(w.ch>=0&&E.ch>=w.ch){E.ch+=1;var p=s.markText(w,E,"mergely ch a rhs");r.change_funcs.push(p)}if(y.ch>=0&&b.ch>=y.ch){b.ch+=1;var p=i.markText(y,b,"mergely ch d lhs");r.change_funcs.push(p)}}for(var o=u["lhs-line-from"]+1;o<u["lhs-line-to"];++o){var f=a+"lhs";i.setLineClass(o,null,f)}var N=r.merge_lhs_button.clone();N.button&&N.button({icons:{primary:"ui-icon-triangle-1-w"},text:!1}),N.addClass("merge-button"),N.attr("id","merge-lhs-"+o),s.addWidget({line:u["rhs-line-from"],ch:0},N.get(0),!1,"over","right");var C=r.merge_rhs_button.clone();C.button&&C.button({icons:{primary:"ui-icon-triangle-1-e"},text:!1}),C.addClass("merge-button"),C.attr("id","merge-rhs-"+o),i.addWidget({line:u["lhs-line-from"],ch:0},C.get(0),!1,"over","right")}}),s.operation(function(){for(var e in n){var t=n[e],r="mergely "+t.op+" cid-"+e+" ";if(t["rhs-line-from"]==t["rhs-line-to"]){if(t["op"]=="a"){var i=r+"bg rhs start end";s.setLineClass(t["rhs-line-from"],null,i)}else if(t["op"]=="d")if(t["lhs-line-from"]>0){var i=r+"rhs start end";s.setLineClass(t["rhs-line-from"],null,i)}else{var i=r+"rhs start";s.setLineClass(t["rhs-line-from"],null,i)}else if(t["op"]=="c"){var i=r+"rhs start end";s.setLineClass(t["rhs-line-from"],null,i)}}else{var i=r+"rhs start";s.setLineClass(t["rhs-line-from"],null,i),i=r+"rhs end",s.setLineClass(t["rhs-line-to"],null,i)}for(var e=t["rhs-line-from"]+1;e<=t["rhs-line-to"];++e){var i=r+"rhs";t["op"]=="c"&&(i="mergely a cid-"+e+" rhs c"),e==t["rhs-line-to"]&&(i+=" end"),s.setLineClass(e,"",i)}}})},_draw_diff:function(e,t,n){var r=$(this.editor[e].getScrollerElement()).height(),i=$(this.editor[e].getScrollerElement()).children(":first-child").height(),s=r/i,o=r/i,u=$(this.editor[e].getScrollerElement()),a=$(this.editor[t].getScrollerElement()),f=this.editor[e].lineCount(),l=this.editor[t].lineCount();this.trace("draw","visible_page_height",r),this.trace("draw","gutter_height",i),this.trace("draw","visible_page_ratio",s),this.trace("draw","lhs-scroller-top",u.scrollTop()),this.trace("draw","rhs-scroller-top",a.scrollTop());var c=document.getElementById(e+"-"+t+"-canvas");if(c==undefined)throw"Failed to find: "+e+"-"+t+"-canvas";$.each($("canvas"),function(){$(this).get(0).height=r});var h=$("#"+this.id+"-lhs-margin"),p=$("#"+this.id+"-rhs-margin");h.unbind("click"),p.unbind("click");var d=h.get(0),v=p.get(0),m=$(h).offset(),g=$(p).offset(),y=c.getContext("2d"),b=d.getContext("2d"),w=v.getContext("2d");b.beginPath(),b.fillStyle=this.settings._bgcolor,b.strokeStyle="#888",b.fillRect(0,0,6.5,r),b.strokeRect(0,0,6.5,r),w.beginPath(),w.fillStyle=this.settings._bgcolor,w.strokeStyle="#888",w.fillRect(0,0,6.5,r),w.strokeRect(0,0,6.5,r);for(var E in n){var S=n[E],x=S["lhs-y-start"],T=S["lhs-y-end"],N=S["rhs-y-start"],C=S["rhs-y-end"];y.beginPath(),y.strokeStyle=this.settings.fgcolor[S.op],y.lineWidth=1,y.moveTo(this.draw_lhs_min,x),y.lineTo(this.draw_lhs_min+this.draw_lhs_width,x),y.lineTo(this.draw_lhs_min+this.draw_lhs_width,T+1),y.lineTo(this.draw_lhs_min,T+1),y.stroke(),y.moveTo(this.draw_rhs_max,N),y.lineTo(this.draw_rhs_max-this.draw_rhs_width,N),y.lineTo(this.draw_rhs_max-this.draw_rhs_width,C+1),y.lineTo(this.draw_rhs_max,C+1),y.stroke(),y.moveTo(this.draw_lhs_min+this.draw_lhs_width,x+(T+1-x)/2),y.lineTo(this.draw_rhs_max-this.draw_rhs_width,N+(C+1-N)/2),y.stroke(),this.trace("draw",S),x=(S["lhs-y-start"]+u.scrollTop())*s,T=(S["lhs-y-end"]+u.scrollTop())*s+1,N=(S["rhs-y-start"]+a.scrollTop())*s,C=(S["rhs-y-end"]+a.scrollTop())*s+1,this.trace("draw","marker calculated",x,T,N,C),b.beginPath(),b.fillStyle=this.settings.fgcolor[S.op],b.strokeStyle="#000",b.lineWidth=.5,b.fillRect(1.5,x,4.5,Math.max(T-x,5)),b.strokeRect(1.5,x,4.5,Math.max(T-x,5)),w.beginPath(),w.fillStyle=this.settings.fgcolor[S.op],w.strokeStyle="#000",w.lineWidth=.5,w.fillRect(1.5,N,4.5,Math.max(C-N,5)),w.strokeRect(1.5,N,4.5,Math.max(C-N,5))}b.fillStyle="rgba(0, 0, 200, 0.5)",w.fillStyle="rgba(0, 0, 200, 0.5)";var k=h.height()*s,L=u.scrollTop()/i*h.height();this.trace("draw","cls.height",h.height()),this.trace("draw","lhs_scroller.scrollTop()",u.scrollTop()),this.trace("draw","gutter_height",i),this.trace("draw","visible_page_ratio",s),this.trace("draw","from",L,"to",k),b.fillRect(1.5,L,4.5,k),w.fillRect(1.5,L,4.5,k),h.click(function(e){var t=e.pageY-m.top-k/2,n=Math.max(0,t/d.height*u.get(0).scrollHeight);u.scrollTop(n)}),p.click(function(e){var t=e.pageY-g.top-k/2,n=Math.max(0,t/v.height*a.get(0).scrollHeight);a.scrollTop(n)})},trace:function(e){this.settings._debug.indexOf(e)>=0&&(arguments[0]=e+":",console.log([].slice.apply(arguments)))}}),$.pluginMaker=function(e){$.fn[e.prototype.name]=function(t){var n=$.makeArray(arguments),r=n.slice(1),i=undefined;this.each(function(){var s=$.data(this,e.prototype.name);if(s){if(typeof t=="string")i=s[t].apply(s,r);else if(s.update)return s.update.apply(s,n)}else new e(this,t)});if(i!=undefined)return i}},$.pluginMaker(Mgly.mergely)